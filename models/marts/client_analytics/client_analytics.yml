version: 2

models:
  - name: mart_program_health
    description: |
      Program Health Dashboard - Employer-Level KPIs
      
      Client-facing mart providing comprehensive program performance metrics aggregated by employer.
      Designed to answer: "How is our employee screening program performing?"
      
      Business Purpose:
      - Monitor enrollment and participation rates
      - Track time-to-screening and operational efficiency
      - Measure follow-up compliance and care continuity
      - Calculate program ROI and cost effectiveness
      - Provide overall program health scoring
      
      Key Stakeholders:
      - Employer HR teams and benefits managers
      - Color Account Managers
      - Executive leadership reviewing client success
      
      Grain: One row per employer organization

      Refresh Frequency: Daily (full refresh)
    columns:
      - name: employer_id
        description: "Unique employer identifier"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_employer')
              field: employer_id
      - name: employer_name
        description: "Company/organization name"
        tests:
          - not_null
      - name: total_enrolled_members
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
        description: "Total members enrolled in screening program"
      - name: enrollment_rate_pct
        description: "% of eligible employees (employee_count) who enrolled - measures program reach"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
      - name: participation_rate_pct
        description: "% of enrolled members who completed at least one screening - KEY SUCCESS METRIC"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
      - name: avg_days_to_first_screening
        description: "Average days from enrollment to first completed screening - measures engagement speed"
      - name: median_days_to_first_screening
        description: "Median days to first screening - less sensitive to outliers than average"
      - name: follow_up_compliance_rate_pct
        description: "% of needed follow-ups that were completed - measures care continuity"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
      - name: program_health_score
        description: |
          Composite score 0-100 measuring overall program performance:
          - 20 points: Activation rate
          - 35 points: Participation rate
          - 35 points: Follow-up compliance rate
          - 10 points: Time-to-screening (≤10 days - 10, between 10 and 20 days - 5, >20 - 0)

          Score interpretation:
          - 80-100: Excellent program performance
          - 60-79: Good performance, minor improvements needed
          - 40-59: Fair performance, significant gaps exist
          - <40: Poor performance, urgent intervention needed
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
              config:
                severity: error
      - name: cancers_detected_per_1000_screenings
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
        description: "Industry standard metric for screening yield - benchmark ~4-8 per 1000"
  
  - name: mart_population_insights
    description: |
      Population Insights Dashboard - Demographic Segmentation

      Client-facing mart providing population health analytics segmented by demographics.
      Designed to answer: "Where should we focus outreach efforts?"

      Business Purpose:
      - Identify underserved population segments
      - Target outreach campaigns to specific demographics
      - Understand engagement patterns by age, gender, location, risk profile
      - Detect health equity gaps and disparities
      - Segment members for personalized interventions

      Key Stakeholders:
      - Employer wellness program managers
      - Color clinical team planning interventions
      - Marketing/outreach teams

      Grain: One row per employer - age_group - gender - state - high_risk_flag combination

      Refresh Frequency: Daily (full refresh)
    columns:
      - name: employer_id
        description: "Unique employer identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dim_employer')
              field: employer_id
      - name: age_group
        description: "Age segment: 'Under 40', '40-49', '50-64', '65+'"
        tests:
          - not_null
          - accepted_values:
              values: ['Under 40', '40-49', '50-64', '65+']
      - name: gender
        description: "Gender: M, F, Other"
        tests:
          - not_null
          - accepted_values:
              values: ['M', 'F', 'Other']
      - name: state
        description: "Member's state of residence"
      - name: high_risk_flag
        description: "Boolean indicating elevated cancer risk (family history, genetic factors)"
      - name: total_members
        description: "Population size of this demographic segment"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"
      - name: screening_rate_pct
        description: "% of segment who completed screening - KEY EQUITY METRIC"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
      - name: engagement_risk_segment
        description: |
          Risk categorization for targeted interventions:
          - 'High Risk - Low Engagement': <50% screening rate - URGENT OUTREACH NEEDED
          - 'Medium Risk - Moderate Engagement': 50-75% screening rate - Needs encouragement
          - 'Low Risk - High Engagement': >75% screening rate - Maintain momentum
        tests:
          - accepted_values:
              values: ['High Risk - Low Engagement', 'Medium Risk - Moderate Engagement', 'Low Risk - High Engagement']
      - name: has_care_gap
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]
              quote: false
        description: "Binary flag indicating segment has members who haven't screened - identifies opportunity areas"
      - name: cancer_detection_rate_per_1000
        description: "Cancers detected per 1,000 screenings in this segment - may reveal high-risk populations"
  
  - name: mart_outcomes_summary
    description: |
      Clinical Outcomes Dashboard - Program Impact
      
      Client-facing mart providing clinical outcome metrics and program impact assessment.
      Designed to answer: "What impact is the program having on health outcomes?"
      
      Business Purpose:
      - Demonstrate program clinical value and ROI
      - Track cancer detection rates and early detection success
      - Monitor care gaps and follow-up completion
      - Calculate cost per cancer detected
      - Measure quality of care delivery
      
      Key Stakeholders:
      - Employer benefits/finance teams evaluating ROI
      - Color clinical leadership
      - Executive teams presenting program value
      
      Grain: One row per employer organization

      Refresh Frequency: Daily (full refresh)
    columns:
      - name: employer_id
        description: "Unique employer identifier"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_employer')
              field: employer_id
      - name: employer_name
        description: "Company/organization name"
        tests:
          - not_null
      - name: total_screenings
        description: "Total screening procedures performed"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: cancer_detections
        description: "Number of cancers detected - PRIMARY OUTCOME METRIC"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: cancers_detected_per_1000_screenings
        description: |
          Industry standard screening yield metric:
          - Mammography benchmark: 4-5 per 1,000
          - Colonoscopy benchmark: 6-8 per 1,000
          Used to validate program clinical effectiveness
      - name: follow_up_completion_rate_pct
        description: "% of abnormal results with completed follow-up - CRITICAL QUALITY METRIC"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
      - name: total_care_gaps_identified
        description: "Number of abnormal findings (abnormal + cancer) requiring follow-up"
      - name: care_gaps_addressed
        description: "Number of follow-ups completed - shows care continuity"
      - name: care_gaps_remaining
        description: "Number of follow-ups needed but not completed - ACTION ITEMS for outreach"
      - name: cost_per_cancer_detected
        description: "Total program cost / cancers detected - ROI metric for employers"
      - name: outcomes_quality_score
        description: |
          Composite clinical quality score 0-100:
          - 50 points: Follow-up completion rate
          - 25 points: Timely results (≤14 days)
          - 25 points: Detection rate (≥4 per 1,000)

          Score interpretation:
          - 80-100: Excellent clinical quality
          - 60-79: Good quality, minor gaps
          - 40-59: Fair quality, improvements needed
          - <40: Poor quality, urgent review required
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
              config:
                severity: error